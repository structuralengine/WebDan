new function(){TableCreator=function(tableId){this._init(tableId)};TableCreator.prototype.GetAllValues=function(){for(var json="",i=0;i<this.cellValues.length;i++){json+=i==0?"[":",";for(var j=0;j<this.cellValues[i].length;j++){json+=j==0?"[":",";json+='"'+this.cellValues[i][j].split("\\").join("\\\\").split('"').join('\\"')+'"'}json+="]"}json+="]";return json};TableCreator.prototype.GetModifiedValues=function(){for(var json="",i=0;i<this.cellValues.length;i++){json+=i==0?"[":",";for(var j=0;j<this.cellValues[i].length;j++){json+=j==0?"[":",";json+=this.cellModified[i][j]?'"'+this.cellValues[i][j].split("\\").join("\\\\").split('"').join('\\"')+'"':"null"}json+="]"}json+="]";return json};TableCreator.prototype._init=function(tableId){var wholeTable=$("#"+tableId);if(wholeTable.length==0){window.alert("id '"+tableId+"' not found");return}var wholeWidth=parseInt(wholeTable.attr("data-adv-width")),wholeHeight=parseInt(wholeTable.attr("data-adv-height")),tableCols=parseInt(wholeTable.attr("data-adv-cols")),leftCols=parseInt(wholeTable.attr("data-adv-left")),rightCols=parseInt(wholeTable.attr("data-adv-right")),tableRows=parseInt(wholeTable.attr("data-adv-rows")),topRows=parseInt(wholeTable.attr("data-adv-top")),bottomRows=parseInt(wholeTable.attr("data-adv-bottom")),referenceVariables=wholeTable.attr("data-adv-reference");if(referenceVariables!=undefined)referenceVariables=jQuery.parseJSON(referenceVariables);for(var iID=null,iType=null,dtpOpen=false,oldText="",numClass=null,cursorMove=false,onEndInput=false,zoneDiv=new Array(9),zoneTable=new Array(9),zoneName=["topleft","topcenter","topright","middleleft","middlecenter","middleright","bottomleft","bottomcenter","bottomright"],i=0;i<9;i++){zoneDiv[i]=$("#"+tableId+"_"+zoneName[i]);zoneTable[i]=$("#"+tableId+"_"+zoneName[i]+"table")}if(zoneTable[4].css("table-layout")=="fixed")for(var i=3;i<6;i++)if(zoneTable[i].length){for(var cols=$("col",zoneTable[i]),tableWidth=0,j=0;j<cols.length;j++)tableWidth+=parseInt($(cols[j]).css("width"));for(var k=i-3;k<9;k+=3)if(zoneTable[k].length){$(zoneDiv[k]).css("width",tableWidth+"px");if(navigator.userAgent.indexOf("Firefox")!=-1)$(zoneTable[k]).css("width","10px");else $(zoneTable[k]).css("width",tableWidth+"px")}}for(var vzone=0;vzone<3;vzone++)for(var hzone=0;hzone<3;hzone++){var i=vzone*3+hzone;if(zoneDiv[i].length){var overflow_x="hidden",overflow_y="hidden";if(hzone==1&&(vzone==1&&bottomRows==0||vzone==2))overflow_x="auto";if(vzone==1&&(hzone==1&&rightCols==0||hzone==2))overflow_y="auto";$(zoneDiv[i]).css("width",zoneTable[i].css("width"));$(zoneDiv[i]).css("overflow-x",overflow_x);$(zoneDiv[i]).css("overflow-y",overflow_y)}}if(wholeWidth)for(var centerWidth=parseInt(zoneDiv[4].css("width")),newCenterWidth=wholeWidth-(leftCols?parseInt(zoneDiv[3].css("width")):0)-(rightCols?parseInt(zoneDiv[5].css("width")):0),i=1;i<=7;i+=3){zoneDiv[i].css("width",newCenterWidth);zoneTable[i].css("width",centerWidth)}if(wholeHeight)for(var middleHeight=parseInt(zoneDiv[4].css("height")),newMiddleHeight=wholeHeight-(topRows?parseInt(zoneDiv[1].css("height")):0)-(bottomRows?parseInt(zoneDiv[7].css("height")):0),i=3;i<=5;i++){zoneDiv[i].css("height",newMiddleHeight);zoneTable[i].css("height",middleHeight)}if(rightCols){var barWidth=parseInt(zoneDiv[5].css("width"))-zoneDiv[5].get(0).clientWidth;zoneDiv[5].css("width",parseInt(zoneDiv[5].css("width"))+barWidth);if(wholeWidth)for(var i=1;i<=7;i+=3)zoneDiv[i].css("width",parseInt(zoneDiv[i].css("width"))-barWidth)}if(rightCols==0)if(wholeWidth){zoneDiv[1].css("width",zoneDiv[4].get(0).clientWidth);zoneDiv[7].css("width",zoneDiv[4].get(0).clientWidth)}else if(parseInt(zoneDiv[4].css("width"))!=zoneDiv[4].get(0).clientWidth)zoneDiv[4].css("width",parseInt(zoneDiv[4].css("width"))*2-zoneDiv[4].get(0).clientWidth);else zoneDiv[4].css("width",parseInt(zoneDiv[4].css("width"))+18);if(bottomRows==0)if(wholeHeight){zoneDiv[3].css("height",zoneDiv[4].get(0).clientHeight);zoneDiv[5].css("height",zoneDiv[4].get(0).clientHeight)}else if(parseInt(zoneDiv[4].css("height"))!=zoneDiv[4].get(0).clientHeight)zoneDiv[4].css("height",parseInt(zoneDiv[4].css("height"))*2-zoneDiv[4].get(0).clientHeight);else zoneDiv[4].css("height",parseInt(zoneDiv[4].css("height"))+18);for(var width=[leftCols?parseInt(zoneDiv[3].css("width")):0,parseInt(zoneDiv[4].css("width")),rightCols?parseInt(zoneDiv[5].css("width")):0],height=[topRows?parseInt(zoneDiv[1].css("height")):0,parseInt(zoneDiv[4].css("height")),bottomRows?parseInt(zoneDiv[7].css("height")):0],y=0,i=0;i<3;i++){if(height[i]==0)continue;for(var x=0,j=0;j<3;j++){if(width[j]==0)continue;zoneDiv[i*3+j].css({top:y,left:x});x+=width[j]}y+=height[i]}trimRowHeight(zoneTable[0],zoneTable[1],zoneTable[2]);trimRowHeight(zoneTable[3],zoneTable[4],zoneTable[5]);trimRowHeight(zoneTable[6],zoneTable[7],zoneTable[8]);wholeTable.css("width",wholeWidth||x);wholeTable.css("height",wholeHeight||y);TrimImagePosition();for(var cellValues=new Array(tableRows),cellModified=new Array(tableRows),i=0;i<tableRows;i++){cellValues[i]=new Array(tableCols);cellModified[i]=new Array(tableCols)}for(var calcCells=new Array(tableRows),i=0;i<tableRows;i++)calcCells[i]=new Array(tableCols);for(var formula=new Formula,dataName=["advType","advFormat","advFormula","advVerify"],i=0;i<9;i++){if(zoneTable[i].length==0)continue;for(var cols=$("col",zoneTable[i]),rows=$("tr",zoneTable[i]),colid=$(cols[0]).attr("id").match(/(.*col)\d+$/)[1],kind=0;kind<4;kind++)for(var tableVal=zoneTable[i].data(dataName[kind]),rindex=0;rindex<rows.length;rindex++)for(var rowVal=$(rows[rindex]).data(dataName[kind]),cells=$("td",rows[rindex]),cindex=0;cindex<cells.length;cindex++){var cell=$(cells[cindex]),match=$(cell).attr("id").match(/.*_R(\d+)C(\d+)$/),rownum=parseInt(match[1]),colnum=parseInt(match[2]);if(cell.data(dataName[kind])==null)if(rowVal!=null)cell.data(dataName[kind],rowVal);else{var col=$("#"+colid+colnum,zoneTable[i]),colVal=col.data(dataName[kind]);if(colVal!=null)cell.data(dataName[kind],colVal);else cell.data(dataName[kind],tableVal)}kind==0&&cell.data(dataName[kind])=="textarea"&&cell.css("white-space","normal");if(kind==0)cellValues[rownum-1][colnum-1]=cell.text();if(kind==2&&cell.data(dataName[kind])!=null){cellPoss=formula.Parse(null,cell.data(dataName[kind]),null);for(var p=0;p<cellPoss.length;p++)if(cellPoss[p].length==2){var row=cellPoss[p][0],col=cellPoss[p][1];if(row<tableRows&&col<tableCols){if(calcCells[row][col]==null)calcCells[row][col]=[];calcCells[row][col].push(cell)}}else for(var beginRow=cellPoss[p][0],beginCol=cellPoss[p][1],endRow=cellPoss[p][2],endCol=cellPoss[p][3],row=beginRow;row<=endRow&&row<tableRows;row++)for(var col=beginCol;col<=endCol&&col<tableCols;col++){if(calcCells[row][col]==null)calcCells[row][col]=[];calcCells[row][col].push(cell)}}}}function trimColWidth(table1,table2,table3){table1.parent().css("width",table2.parent().css("width"));for(var cols1=$("col",table1),cols2=$("col",table2),cols3=$("col",table3),i=0;i<cols1.length;i++){var width=GetComputedStyle($("col",table2).get(i)).width;cols1.eq(i).css("width",width);cols2.eq(i).css("width",width);cols3.eq(i).css("width",width)}}function trimRowHeight(table1,table2,table3){for(var rows1=$("tr",table1),rows2=$("tr",table2),rows3=$("tr",table3),orgHeight=30,i=0;i<rows1.length;i++){rows2.eq(i).css("height",orgHeight);var height=rows2.eq(i).height();rows1.eq(i).css("height",height);rows2.eq(i).css("height",height);rows3.eq(i).css("height",height)}}function TrimImagePosition(){for(var image=$("#"+tableId+" img"),i=0;i<image.length;i++){var position=$(image[i]).data("advPosition");if(position!=null){var param=position.split(",");if(param.length==4){var cell=$("#"+tableId+"_R"+param[1]+"C"+param[0]);if(cell.length>0){$(image[i]).css("left",parseInt(cell.get(0).offsetLeft)+parseInt(param[2]));$(image[i]).css("top",parseInt(cell.get(0).offsetTop)+parseInt(param[3]))}else{for(var left=0,top=0,j=0;j<tableRows;j++){var cell=$("#"+tableId+"_R"+j+"C"+param[0]);if(cell.length>0){$(image[i]).css("left",parseInt(cell.get(0).offsetLeft)+parseInt(param[2]));break}}for(var j=0;j<tableCols;j++){var cell=$("#"+tableId+"_R"+param[1]+"C"+j);if(cell.length>0){$(image[i]).css("top",parseInt(cell.get(0).offsetTop)+parseInt(param[3]));break}}}}}}}function GetComputedStyle(element){return element.currentStyle||document.defaultView.getComputedStyle(element,"")}function BeginInput(element,dtpEnable){TrimImagePosition();var dataType=$(element).data("advType"),dataFormula=$(element).data("advFormula");if(dataType!="text"&&dataType!="textarea"&&dataType!="number"&&dataType!="date"&&dataType!="select"&&dataType!="auto"||dataFormula!=null)return;$(element).addClass("selected");var text=$(element).text(),width="width:"+$(element).width()+"px;",fontsize=" font-size:"+$(element).css("font-size")+";",fontfamily=" font-family:"+$(element).css("font-family")+";";switch(dataType){case "text":case "number":case "date":case "auto":if(dataType=="number")text=text.replace(/[^0-9.\-]/g,"");$(element).html("<input type='text' style='margin:0; border:0; padding:0;"+width+fontfamily+fontsize+"' value='"+text+"'/>");if(dataType=="date"&&dtpEnable){var dataFormat=$(element).data("advFormat");if(dataFormat==undefined||dataFormat=="")dataFormat="yy-mm-dd";else dataFormat=dataFormat.slice(1);dtpOpen=true;$("input",$(element)).datepicker({showOn:"focus",autoSize:true,dateFormat:dataFormat,showButtonPanel:true,onClose:function(date){if(date.length>0)text=date;$(element).html("<input type='text' style='margin:0; border:0; padding:0;"+width+fontfamily+fontsize+"' value='"+text+"'/>");$("input",$(element))[0].focus();dtpOpen=false;cursorMove=true}})}trimRowHeight(zoneTable[3],zoneTable[4],zoneTable[5]);$("input",$(element))[0].focus();$("input",$(element))[0].select();break;case "textarea":$(element).html("<textarea style='margin:0; border:0; padding:0;"+width+fontfamily+fontsize+"' >"+text+"</textarea>");trimRowHeight(zoneTable[3],zoneTable[4],zoneTable[5]);$("textarea",$(element))[0].focus();break;case "select":var dataFormat=$(element).data("advFormat");if(dataFormat==undefined)dataFormat="";for(var selectItems=dataFormat.slice(1).split(";"),select="<select style='margin:0; border:0; padding:0;"+width+fontfamily+fontsize+"' >",i=0;i<selectItems.length;i++)select+="<option value='"+selectItems[i]+"'"+(text==selectItems[i]?"selected >":">")+selectItems[i]+"</option>";select+="</select>";$(element).html(select);trimRowHeight(zoneTable[3],zoneTable[4],zoneTable[5]);$("select",$(element))[0].focus();break}iType=dataType;iID=element.id;oldText=text;cursorMove=true}function EndInput(){if(iID==null||dtpOpen==true||onEndInput)return true;onEndInput=true;var item=$("#"+iID);switch(iType){default:var text=$("input",item).val();if(iType=="number")text=ZenToHan(text);if(VerifyValue(text)==false){$("input",item).val(oldText);$("input",item).focus();onEndInput=false;return false}break;case "textarea":var text=$("textarea",item).val();if(VerifyValue(text)==false){$("input",item).val(oldText);$("input",item).focus();onEndInput=false;return false}break;case "select":var text=$("select",item).val();break}var modified=text!=oldText;if(iType=="number"&&item.data("advFormat")!=undefined)text=NumFormat(item,parseFloat(text));item.html(text);if(iType=="auto"){align=text.match(/[^0-9\-\\,.]+/)?"left":"right";item.css("text-align",align)}var match=iID.match(/.*_R(\d+)C(\d+)$/),row=parseInt(match[1])-1,col=parseInt(match[2])-1;cellValues[row][col]=text;if(modified)cellModified[row][col]=true;try{CalcValue(row,col)}catch(e){}item.removeClass("selected");iID=null;onEndInput=false;return true}function CalcValue(row,col){if(calcCells[row][col]!=null)for(var i=0;i<calcCells[row][col].length;i++){var calcCell=calcCells[row][col][i],value=formula.Parse(cellValues,calcCell.data("advFormula"),referenceVariables),dataType=calcCell.data("advType");if(dataType=="number"&&calcCell.data("advFormat")!=undefined){if(isNaN(value))value=parseFloat(value.toString().replace(/[^0-9.\-]/g,""));var text=NumFormat(calcCell,value)}else var text=value.toString();calcCell.html(text);var match=$(calcCell).attr("id").match(/.*_R(\d+)C(\d+)$/),row2=parseInt(match[1])-1,col2=parseInt(match[2])-1;cellValues[row2][col2]=text;CalcValue(row2,col2)}}function NumFormat(item,number){if(isNaN(number))return "";var prePhrase="",postPhrase="",dataSign=false,dataComma=false,iMaxLen=0,iMinLen=0,dMaxLen=0,dMinLen=0,numClass=null,dataFormat=item.data("advFormat");if(dataFormat!=undefined){dataFormat=dataFormat.slice(1);var match=dataFormat.match(/(.*)\((.+?)\)$/);if(match!=null&&match.length==3){numClass=match[2].split(";");dataFormat=match[1]}}if(dataFormat!=undefined&&(dataFormat.indexOf("0")>=0||dataFormat.indexOf("#")>=0)){for(var startPos=-1,endPos=-1,pointPos=-1,i=0;i<dataFormat.length;i++){c=dataFormat.charAt(i);if(c=="#"||c=="0"||c=="-"||c=="."||c==","){if(startPos==-1)startPos=i;endPos=i+1;if(c=="#"||c=="0")if(pointPos==-1){iMaxLen++;if(c=="0")iMinLen++}else{dMaxLen++;if(c=="0")dMinLen++}if(c==".")pointPos=i;if(c=="-")dataSign=true;if(c==",")dataComma=true}}prePhrase=dataFormat.slice(0,startPos);postPhrase=dataFormat.slice(endPos)}if(numClass!=null){for(var i=0;i<3&&i<numClass.length;i++)numClass[i]!=""&&item.removeClass(numClass[i]);for(var i=0;i<3&&i<numClass.length;i++)numClass[i]!=""&&(i==0&&number>0||i==1&&number<0||i==2&&number==0)&&item.addClass(numClass[i])}if(number==0&&iMinLen==0&&dMinLen==0)return "";var minus=number<0;number=Math.abs(number).toString();point=number.indexOf(".");var inum,dnum;if(point<0){inum=number;dnum=""}else{inum=number.slice(0,point);dnum=number.slice(point)}while(inum.length<iMinLen)inum="0"+inum;if(dataComma)while(inum!=(inum=inum.replace(/^(-?\d+)(\d{3})/,"$1,$2")));if(minus)inum="-"+inum;if(dMaxLen==0||dMinLen==0&&dnum=="")dnum="";else{if(dMinLen>0){if(dnum=="")dnum=".";while(dnum.length<dMinLen+1)dnum=dnum+"0"}if(dnum.length>dMaxLen+1)dnum=dnum.slice(0,dMaxLen+1)}return prePhrase+inum+dnum+postPhrase}function VerifyValue(text){if(text==oldText)return true;var dataVerify=$("#"+iID).data("advVerify");if(dataVerify==null||dataVerify=="")return true;var match=dataVerify.match(/(.*)\((.+?)\)$/),message=null;if(match!=null&&match.length==3){message=match[2];dataVerify=match[1]}else message="\u5165\u529b\u5024\u306b\u8aa4\u308a\u304c\u3042\u308a\u307e\u3059";if(iType=="number"){limit=dataVerify.split("/");if(limit.length==2){var number=parseFloat(text);if((limit[0]==""||number>=parseFloat(limit[0]))&&(limit[1]==""||number<=parseFloat(limit[1])))return true}}else{var flag="";if(dataVerify.slice(-2)=="/i"){if(text.match(RegExp(dataVerify.slice(0,dataVerify.length-2),"i")))return true}else if(text.match(RegExp(dataVerify)))return true}window.alert(message);return false}function GotoNextCell(e){var c=e.keyCode;if(c!=9&&c!=13&&(c<37||c>40))return false;if(c!=13&&!cursorMove)return false;if(c==9)c=e.shiftKey?37:13;var match=iID.match(/.*_R(\d+)C(\d+)$/);if(match==null||match.length!=3)return false;var col=parseInt(match[2]),row=parseInt(match[1]),c2=c;while(true){switch(c2){case 13:col++;break;case 37:col--;break;case 38:row--;break;case 39:col++;break;case 40:row++;break}if(col>tableCols){switch(c){case 13:col=1;row++;break;case 38:col=parseInt(match[2]);row--;break;case 40:col=parseInt(match[2]);row++;break;default:return false}c2=c}if(col<1||row<1||row>tableRows){if(c==13)if(EndInput()==true)if(navigator.userAgent.indexOf("MSIE")==-1){e.preventDefault();FocusNextItem($("#"+tableId)[0])}else e.keyCode=9;else e.preventDefault();return false}var cell=$("#"+tableId+"_R"+row+"C"+col);if(cell.length>0){var dataType=cell.data("advType"),dataFormula=cell.data("advFormula");if((dataType=="text"||dataType=="textarea"||dataType=="number"||dataType=="date"||dataType=="select"||dataType=="auto")&&dataFormula==null){if(EndInput()==false){e.preventDefault();return false}if(navigator.userAgent.indexOf("Firefox")!=-1&&cell.data("advType")=="select")setTimeout(function(){BeginInput(cell[0],false)},50);else BeginInput(cell[0],false);e.preventDefault();return true}}if(c2==38||c2==40){col=0;c2=39}}}function ZenToHan(text){for(var han="0123456789.,-+",zen="\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19\uff0e\uff0c\uff0d\uff0b",str="",i=0;i<text.length;i++){var c=text.charAt(i),n=zen.indexOf(c,0);if(n>=0)c=han.charAt(n);str+=c}return str}function FocusNextItem(item){for(var allItems=$("*"),i=0;i<allItems.length;i++)if(item==allItems[i]){for(var j=0;j<allItems.length;j++){var index=(i+j+1)%allItems.length;if(allItems[index].nodeName=="INPUT"||allItems[index].nodeName=="TEXTAREA"||allItems[index].nodeName=="SELECT"||allItems[index].nodeName=="BUTTON"){allItems.get(index).focus();break}}break}}zoneDiv[4].scroll(function(){zoneDiv[1].scrollLeft(zoneDiv[4].scrollLeft());zoneDiv[7].scrollLeft(zoneDiv[4].scrollLeft());zoneDiv[3].scrollTop(zoneDiv[4].scrollTop());zoneDiv[5].scrollTop(zoneDiv[4].scrollTop())});zoneDiv[5].scroll(function(){zoneDiv[3].scrollTop(zoneDiv[5].scrollTop());zoneDiv[4].scrollTop(zoneDiv[5].scrollTop())});zoneDiv[7].scroll(function(){zoneDiv[1].scrollLeft(zoneDiv[7].scrollLeft());zoneDiv[4].scrollLeft(zoneDiv[7].scrollLeft())});$("#"+tableId+" td").click(function(){if($("input",this)[0]||$("textarea",this)[0]||$("select",this)[0])return;EndInput()&&BeginInput(this,false)});$(document).on("click","#"+tableId+" input",function(e){if(iType=="date"&&!dtpOpen){var element=$("#"+iID)[0];EndInput();BeginInput(element,true)}cursorMove=false});$(document).on("click","#"+tableId+" textarea",function(e){cursorMove=false});$(document).on("click","#"+tableId+" select",function(e){cursorMove=false});$(document).on("blur","#"+tableId+" input",function(e){EndInput()});$(document).on("blur","#"+tableId+" textarea",function(e){EndInput()});$(document).on("blur","#"+tableId+" select",function(e){EndInput()});$(document).on("keydown","#"+tableId+" input",function(e){var c=e.keyCode;if(iType=="number"){if(c>=48&&c<=57||c>=96&&c<=105||!cursorMove&&c==37||!cursorMove&&c==39||c==8||c==45||c==46||c==36||c==35||c==229||c==244)return;if(document.selection)var sel=document.selection.createRange().text;else var sel=document.getSelection();if(this.value.indexOf("-")<0||this.value==sel)if(c==189||c==109)return;if(this.value.indexOf(".")<0||this.value==sel)if(c==190||c==110)return;c!=9&&c!=13&&e.preventDefault()}GotoNextCell(e)});$(document).on("keydown","#"+tableId+" textarea",function(e){GotoNextCell(e)});$(document).on("keydown","#"+tableId+" select",function(e){GotoNextCell(e)});this.cellValues=cellValues;this.cellModified=cellModified}}